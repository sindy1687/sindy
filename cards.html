<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¡ç‰‡å€‰åº« - Typing Hero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="card-style.css">
  <style>
    /* ====== å…¨åŸŸæ¨£å¼ ====== */
    :root {
      --glow-cyan: #00ffff;
      --glow-magenta: #a259ff;
      --glow-gold: #ffd700;
      --glow-red: #ff6b6b;
      --bg-dark: rgba(10, 20, 40, 0.85);
    }
    html {
      scroll-behavior: smooth;
    }
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: url('https://wallpaperaccess.com/full/192936.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      text-align: center;
      overflow-y: scroll;
    }

    /* ====== å…¨åŸŸæ²è»¸æ¨£å¼ ====== */
    body::-webkit-scrollbar {
      width: 12px;
    }
    body::-webkit-scrollbar-track {
      background: #0a1428; /* æ·±è—è‰²èƒŒæ™¯ï¼Œé…åˆä¸»é¡Œ */
    }
    body::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--glow-cyan), var(--glow-magenta));
      border-radius: 6px;
      border: 2px solid #0a1428; /* å‰µé€ æ‡¸æµ®æ„Ÿ */
    }
    body::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--glow-gold), var(--glow-red)); /* æ‡¸åœæ™‚è®Šè‰² */
    }

    header {
      background: rgba(10, 20, 40, 0.85);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 24px 8px #00ffff88, 0 0 40px 0 #a259ff33 inset;
      border-bottom: 2px solid var(--glow-cyan);
      backdrop-filter: blur(4px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 {
      margin: 0;
      font-size: 2.1rem;
      color: #00ffff;
      letter-spacing: 2px;
      text-shadow: 0 0 12px #00ffff, 0 0 32px #a259ff;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .btn {
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }

    .stars-display {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: var(--bg-dark);
      border: 2px solid var(--glow-gold);
      border-radius: 12px;
      font-size: 1.2rem;
      color: var(--glow-gold);
      font-weight: bold;
      text-shadow: 0 0 8px var(--glow-gold);
      box-shadow: 0 0 16px #ffd70055;
      transition: all 0.3s ease;
    }
    .stars-display:hover {
      transform: scale(1.05);
      box-shadow: 0 0 24px #ffd70088;
    }

    /* ====== æ§åˆ¶åˆ—ï¼ˆæœå°‹ã€ç¨€æœ‰åº¦ã€é¡åˆ¥ï¼‰ ====== */
    #controls {
      margin: 20px auto;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 900px;
      padding: 0 10px;
      background: rgba(10, 20, 40, 0.7);
      border-radius: 14px;
      box-shadow: 0 0 24px #00ffff33, 0 0 40px #a259ff22 inset;
      border: 2px solid #00ffff;
    }
    #controls input,
    #controls select {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1.5px solid #00ffff;
      background: rgba(10, 20, 40, 0.7);
      color: #00ffff;
      font-size: 0.95rem;
      margin-bottom: 8px;
      box-shadow: 0 0 8px #00ffff33;
      transition: all 0.3s ease;
    }
    #controls input:focus,
    #controls select:focus {
      outline: none;
      border-color: var(--glow-gold);
      box-shadow: 0 0 12px var(--glow-gold);
    }
    #controls button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1.5px solid #00ffff;
      background: rgba(10, 20, 40, 0.7);
      color: #00ffff;
      font-size: 0.95rem;
      margin-bottom: 8px;
      box-shadow: 0 0 16px #00ffff88;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #controls button:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 12px #00ffff66;
    }
    #controls button.active {
      background: rgba(0, 255, 255, 0.3);
      color: #fff;
      box-shadow: 0 0 16px #00ffff88;
    }

    /* ====== é ç±¤æŒ‰éˆ• ====== */
    .tab-container {
      display: flex;
      gap: 8px;
    }
    .tab-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1.5px solid var(--glow-cyan);
      background: rgba(10, 20, 40, 0.7);
      color: var(--glow-cyan);
      font-size: 0.95rem;
      margin-bottom: 8px;
      box-shadow: 0 0 8px #00ffff33;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Orbitron', sans-serif;
    }
    .tab-btn:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 12px #00ffff66;
    }
    .tab-btn.active {
      background: var(--glow-cyan);
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 16px #00ffff88;
    }

    /* ====== æ”¶é›†é€²åº¦ ====== */
    #progress {
      margin: 10px 0;
      font-size: 1.1rem;
      color: #ffd700;
      text-shadow: 0 0 8px #ffd700, 0 0 16px #00ffff;
    }

    /* ====== å¡ç‰‡æ ¼å­ï¼ˆå››æ¬„ã€å¯¬åº¦ 180pxï¼‰ ====== */
    #cardGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      padding: 28px 20px 10px 20px;
      justify-content: center;
      overflow-x: auto;
      box-sizing: border-box;
      background: rgba(10, 20, 40, 0.7);
      border-radius: 14px;
      box-shadow: 0 0 32px #00ffff33, 0 0 80px #a259ff22 inset;
      position: relative;
      max-width: 1000px;
      margin: 0 auto;
      border: 2px solid #00ffff;
    }
    #cardGrid:before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://png.pngtree.com/thumb_back/fw800/background/20230613/pngtree-cosmic-starry-sky-background-image_2890957.jpg') repeat center center,
                  linear-gradient(to bottom, rgba(10, 20, 40, 0.5) 0%, rgba(10, 20, 40, 0.9) 100%);
      background-blend-mode: overlay;
      opacity: 0.2;
      border-radius: 14px;
      pointer-events: none;
      z-index: 0;
    }
    #cardGrid > * { position: relative; z-index: 1; }
    .card {
      width: 180px;
      height: 280px;
      position: relative;
      background: rgba(10, 20, 40, 0.85);
      border-radius: 16px;
      padding: 10px;
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      animation: float 3s ease-in-out infinite;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      box-shadow: 0 0 16px #00ffff55, 0 0 32px #a259ff33;
      border: 2.5px solid #00ffff;
      backdrop-filter: blur(8px);
    }
    .card:hover {
      transform: translateY(-10px) scale(1.06) rotate(-2deg);
      box-shadow: 0 15px 32px rgba(0,0,0,0.3), 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    .card.locked {
      cursor: default;
      opacity: 0.5;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .card img {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    .card .card-media {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    .card video.card-media {
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: border-color 0.3s ease;
    }
    .card:hover video.card-media {
      border-color: rgba(0, 255, 255, 0.8);
    }
    .card.locked img {
      filter: grayscale(1) brightness(0.3);
    }
    .stars {
      margin-top: 4px;
      font-size: 1.1rem;
      color: #ffd700;
      line-height: 1;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #fff, 0 0 16px #00ffff;
    }
    .card .label {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #00ffff;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      width: 100%;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      line-height: 1.2;
      word-wrap: break-word;
      hyphens: auto;
      min-height: 2.4em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .card .label .chinese-text {
      font-size: 0.9rem;
      color: #00ffff;
      margin-bottom: 2px;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      font-weight: bold;
    }
    
    .card .label .english-text {
      font-size: 0.8rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700, 0 0 12px #ffaa00;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .card .category-tag {
      margin-top: 4px;
      font-size: 0.85rem;
      color: #ffd700;
      text-shadow: 0 0 6px #fff, 0 0 12px #00ffff;
    }
    
    /* æ–°å¢ï¼šå¡ç‰‡æè¿°æ¨£å¼ */
    .card .description-tag {
      margin-top: 2px;
      font-size: 0.7rem;
      color: #ccc;
      text-shadow: 0 0 4px #ccc;
      line-height: 1.1;
      max-height: 2.2em;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      word-wrap: break-word;
      hyphens: auto;
      padding: 0 2px;
    }
    
    .card .shard-count {
      position: absolute;
      bottom: 6px;
      left: 6px;
      background: rgba(0, 255, 255, 0.85);
      color: #000;
      padding: 3px 7px;
      font-size: 0.85rem;
      border-radius: 6px;
      box-shadow: 0 0 8px #00ffff;
      font-weight: bold;
    }
    .card.unlocked .shard-count {
      background: rgba(120, 255, 180, 0.85);
      color: #003c00;
    }
    .shard-count.shard-excess {
      font-weight: bold;
      background: linear-gradient(90deg, #ff8a00 0%, #e52e71 100%) !important;
      color: #fff !important;
      box-shadow: 0 0 8px #ff8a00;
    }
    .shard-count.shard-unlocked {
        font-size: 1.1rem;
    }
    .common { border: 2.5px solid #00ffff; }
    .rare   { border: 2.5px solid #a259ff; }
    .epic   { border: 2.5px solid #ffd700; box-shadow: 0 0 16px #ffd700; }
    .rank-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 0.95rem;
      font-weight: bold;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      z-index: 10;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
    }
    .card.common .rank-badge {
      background: #00ffff;
      border: 2px solid #00ffff;
      color: #000;
    }
    .card.rare .rank-badge {
      background: #a259ff;
      border: 2px solid #a259ff;
      color: #fff;
    }
    .card.epic .rank-badge {
      background: #ffd700;
      border: 2px solid #ffd700;
      color: #000;
    }

    /* ====== é®ç½© & Modal ====== */
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 900;
    }
    /* Modal å¤–æ¡†å¥—ç”¨èˆ‡å¡ç‰‡ç›¸åŒè¨­å®š */
    #modal .card {
      width: 260px;
      height: 430px;
      margin: 0 auto;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 16px;
      padding: 14px;
      border: 2.5px solid #00ffff;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    #modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: transparent;
      padding: 0;
      border: none;
      z-index: 1000;
      transition: transform 0.3s;
      color: #fff;
      box-sizing: border-box;
    }
    #modal.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    #modal .card img {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    #modal .card .card-media {
      width: 100%;
      height: 50%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }
    #modal .card video.card-media {
      border: 2px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }
    #modal .card video.card-media::-webkit-media-controls {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
    }
    #modal .card .stars {
      margin-top: 6px;
      font-size: 1.1rem;
      color: #ffd700;
      line-height: 1;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #fff, 0 0 16px #00ffff;
    }
    #modal .card .label {
      margin-top: 6px;
      font-size: 1rem;
      color: #00ffff;
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
      width: 100%;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      text-align: center;
      line-height: 1.3;
      word-wrap: break-word;
      hyphens: auto;
      min-height: 2.6em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #modal .card .label .chinese-text {
      font-size: 1rem;
      color: #00ffff;
      margin-bottom: 3px;
      text-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
      font-weight: bold;
    }
    #modal .card .label .english-text {
      font-size: 0.9rem;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700, 0 0 12px #ffaa00;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    #modal .card .category-tag {
      margin-top: 4px;
      font-size: 0.95rem;
      color: #ffd700;
      text-shadow: 0 0 6px #fff, 0 0 12px #00ffff;
      text-align: center;
    }
    #modal .card .rank-badge {
      top: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      font-size: 1.1rem;
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #a259ff;
    }
    #modal .card .shard-count {
      bottom: 8px;
      left: 8px;
      background: rgba(0, 255, 255, 0.85);
      color: #000;
      padding: 3px 7px;
      font-size: 0.95rem;
      border-radius: 6px;
      box-shadow: 0 0 8px #00ffff;
      font-weight: bold;
    }
    #modal .card.unlocked .shard-count {
      background: rgba(120, 255, 180, 0.85);
    }
    #modal .description {
      margin-top: 14px;
      text-align: left;
      line-height: 1.6;
      font-size: 1.05rem;
      max-height: 160px;
      overflow-y: auto;
      width: 260px;
      background: rgba(10, 20, 40, 0.95);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 0 16px #00ffff99, 0 0 40px #a259ff44 inset;
      color: #fff;
      text-shadow: 0 0 8px #000a;
    }
    #modal .description::-webkit-scrollbar {
      width: 8px;
    }
    #modal .description::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.3);
      border-radius: 4px;
    }
    #modal .description::-webkit-scrollbar-thumb {
      background: var(--glow-cyan);
      border-radius: 4px;
    }
    #modal .description::-webkit-scrollbar-thumb:hover {
      background: var(--glow-gold);
    }
    
    /* å¡ç‰Œæ•ˆæœè³‡è¨Šæ¨£å¼ */
    #modal .card-effect {
      margin-top: 12px;
      padding: 10px;
      background: rgba(0, 255, 255, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    #modal .card-effect h4 {
      color: #00ffff;
      margin: 0 0 8px 0;
      font-size: 1rem;
      text-align: center;
    }
    
    #modal .card-effect .effect-desc {
      color: #ffd700;
      font-size: 0.9rem;
      text-align: center;
      margin: 0;
      font-weight: 500;
    }
    
    #modal .card-effect .effect-type {
      color: #a259ff;
      font-size: 0.8rem;
      text-align: center;
      margin-top: 5px;
      opacity: 0.8;
    }
    .sound-btn-modal {
      background: linear-gradient(90deg, #00ffff 0%, #a259ff 100%);
      color: #000;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.1rem;
      margin-top: 12px;
      box-shadow: 0 0 16px #00ffff, 0 0 24px #a259ff99;
      font-weight: bold;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .sound-btn-modal:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
    }
    .disenchant-btn-modal {
      background: linear-gradient(90deg, #ff8a00 0%, #e52e71 100%);
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 16px #ff8a00, 0 0 24px #e52e7199;
      font-size: 1.1rem;
      letter-spacing: 1px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .disenchant-btn-modal:hover {
      transform: scale(1.07);
      box-shadow: 0 0 32px #ff8a00, 0 0 48px #e52e71cc;
    }
    .disenchant-btn-modal:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
      box-shadow: none;
    }
    .disenchant-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .quantity-selector {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border: 1px solid #ff8a00;
    }
    .quantity-btn {
      background: transparent;
      border: none;
      color: #ff8a00;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      padding: 0 12px;
    }
    .quantity-btn:hover {
      color: #fff;
    }
    #disenchant-quantity {
      width: 40px;
      text-align: center;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      -moz-appearance: textfield;
    }
    #disenchant-quantity::-webkit-outer-spin-button,
    #disenchant-quantity::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .close-btn {
      position: absolute;
      top: -16px; left: -16px;
      background: red;
      color: white;
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 6px #f00;
    }

    /* ====== æ–°å¡ç‰‡åœ–æ¨™ ====== */
    .new-card-badge {
      position: absolute;
      top: 6px;
      left: 6px;
      background: linear-gradient(45deg, #ff6b6b, #ffd93d, #ff6b6b);
      background-size: 200% 200%;
      color: #fff;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: bold;
      border-radius: 15px;
      z-index: 15;
      box-shadow: 
        0 0 15px #ff6b6b, 
        0 0 25px #ffd93d,
        0 0 35px #ff6b6b;
      animation: 
        newCardPulse 1.5s ease-in-out infinite,
        newCardGradient 2s ease-in-out infinite;
      text-shadow: 0 0 6px #000;
      border: 2px solid rgba(255, 255, 255, 0.8);
      transform-origin: center;
    }
    
    @keyframes newCardPulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        box-shadow: 
          0 0 15px #ff6b6b, 
          0 0 25px #ffd93d,
          0 0 35px #ff6b6b;
      }
      25% {
        transform: scale(1.15) rotate(-2deg);
        box-shadow: 
          0 0 25px #ff6b6b, 
          0 0 35px #ffd93d,
          0 0 45px #ff6b6b;
      }
      50% { 
        transform: scale(1.25) rotate(0deg);
        box-shadow: 
          0 0 30px #ff6b6b, 
          0 0 40px #ffd93d,
          0 0 50px #ff6b6b;
      }
      75% {
        transform: scale(1.15) rotate(2deg);
        box-shadow: 
          0 0 25px #ff6b6b, 
          0 0 35px #ffd93d,
          0 0 45px #ff6b6b;
      }
    }
    
    @keyframes newCardGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .new-card-glow {
      animation: newCardGlow 2s ease-in-out infinite;
      position: relative;
    }
    
    .new-card-glow::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      right: -5px;
      bottom: -5px;
      background: linear-gradient(45deg, #ff6b6b, #ffd93d, #ff6b6b);
      border-radius: 20px;
      z-index: -1;
      opacity: 0.6;
      animation: newCardGlowRing 2s ease-in-out infinite;
    }
    
    @keyframes newCardGlow {
      0%, 100% { 
        box-shadow: 
          0 0 20px #00ffff55, 
          0 0 40px #a259ff33,
          0 0 15px #ff6b6b88;
      }
      25% {
        box-shadow: 
          0 0 25px #00ffff66, 
          0 0 45px #a259ff44,
          0 0 25px #ff6b6b99,
          0 0 35px #ffd93d66;
      }
      50% { 
        box-shadow: 
          0 0 30px #00ffff77, 
          0 0 50px #a259ff55,
          0 0 35px #ff6b6baa,
          0 0 45px #ffd93d77;
      }
      75% {
        box-shadow: 
          0 0 25px #00ffff66, 
          0 0 45px #a259ff44,
          0 0 25px #ff6b6b99,
          0 0 35px #ffd93d66;
      }
    }
    
    @keyframes newCardGlowRing {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.6;
      }
      50% { 
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    .video-indicator {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 0.8rem;
      z-index: 10;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      animation: videoIndicatorPulse 2s ease-in-out infinite;
    }
    
    @keyframes videoIndicatorPulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 0.8;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
    }

    /* ====== YouTube å½±ç‰‡ç›¸é—œæ¨£å¼ ====== */
    .card iframe.card-media {
      border: 2px solid rgba(0, 255, 255, 0.3);
      transition: border-color 0.3s ease;
      pointer-events: none; /* é˜²æ­¢åœ¨å¡ç‰‡ä¸Šç›´æ¥æ“ä½œ iframe */
    }
    .card:hover iframe.card-media {
      border-color: rgba(0, 255, 255, 0.8);
    }
    .card .youtube-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
      z-index: 5;
    }
    .card .youtube-overlay:hover {
      background: rgba(0, 0, 0, 0.1);
    }
    .card .youtube-overlay .play-button {
      width: 40px;
      height: 40px;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      transition: all 0.3s ease;
    }
    .card .youtube-overlay:hover .play-button {
      transform: scale(1.2);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
    }
    .card .video-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00ffff;
      font-size: 12px;
      z-index: 6;
    }
    .card .video-error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff6b6b;
      font-size: 12px;
      z-index: 6;
      text-align: center;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px;
      border-radius: 6px;
    }

    /* Modal ä¸­çš„ YouTube å½±ç‰‡æ¨£å¼ */
    #modal .card iframe.card-media {
      border: 2px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      pointer-events: auto; /* Modal ä¸­å¯ä»¥æ“ä½œ */
    }
    #modal .card iframe.card-media::-webkit-media-controls {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
    }

    /* ====== å½±ç‰‡æŒ‰éˆ•æ¨£å¼ ====== */
    .video-button {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      background: rgba(255, 0, 0, 0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      transition: all 0.3s ease;
      box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .video-button:hover {
      transform: scale(1.1);
      background: rgba(255, 0, 0, 1);
      box-shadow: 0 0 16px rgba(255, 0, 0, 0.8);
      border-color: rgba(255, 255, 255, 0.8);
    }
    
    .video-icon {
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
    }

    /* æ–°å¢ï¼šåª’é«”å®¹å™¨æ¨£å¼ */
    .media-container {
      position: relative;
      width: 100%;
      height: 50%;
    }
    
    .media-container .card-media {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      filter: drop-shadow(0 0 12px #00ffffcc);
      object-fit: cover;
      background: #000;
    }

    /* ====== å½±ç‰‡ Modal æ¨£å¼ ====== */
    .video-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }
    
    .video-modal-content {
      background: rgba(10, 20, 40, 0.95);
      border: 2px solid #00ffff;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc;
    }
    
    .video-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: rgba(0, 255, 255, 0.1);
      border-bottom: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    .video-modal-header h3 {
      color: #00ffff;
      margin: 0;
      font-size: 1.2rem;
      text-shadow: 0 0 8px #00ffff;
    }
    
    .video-modal-close {
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-modal-close:hover {
      background: rgba(255, 0, 0, 1);
      transform: scale(1.1);
      box-shadow: 0 0 12px rgba(255, 0, 0, 0.8);
    }
    
    .video-modal-body {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 400px;
    }
    
    .video-modal-body iframe,
    .video-modal-body video {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }
    
    .video-modal-body iframe {
      background: #000;
    }
    
    .video-modal-body video {
      background: #000;
    }
    
    /* ====== æˆå°±ç³»çµ±æ¨£å¼ ====== */
    .badge {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid;
      position: relative;
    }
    
    .badge.locked {
      background: rgba(128, 128, 128, 0.3);
      border-color: #666;
      color: #666;
      cursor: default;
      filter: grayscale(1);
    }
    
    .badge.unlocked {
      cursor: pointer;
      animation: badgeGlow 2s ease-in-out infinite alternate;
    }
    
    .badge.unlocked:hover {
      transform: scale(1.2);
      box-shadow: 0 0 20px currentColor;
    }
    
    .badge-bronze.unlocked {
      background: linear-gradient(45deg, #cd7f32, #daa520);
      border-color: #cd7f32;
      color: #fff;
      box-shadow: 0 0 12px #cd7f32;
    }
    
    .badge-silver.unlocked {
      background: linear-gradient(45deg, #c0c0c0, #e5e4e2);
      border-color: #c0c0c0;
      color: #333;
      box-shadow: 0 0 12px #c0c0c0;
    }
    
    .badge-gold.unlocked {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      border-color: #ffd700;
      color: #333;
      box-shadow: 0 0 12px #ffd700;
    }
    
    .badge-platinum.unlocked {
      background: linear-gradient(45deg, #e5e4e2, #b4b4b4);
      border-color: #e5e4e2;
      color: #333;
      box-shadow: 0 0 12px #e5e4e2;
    }
    
    .badge-diamond.unlocked {
      background: linear-gradient(45deg, #b9f2ff, #00ffff);
      border-color: #b9f2ff;
      color: #333;
      box-shadow: 0 0 12px #b9f2ff;
    }
    
    @keyframes badgeGlow {
      0% { box-shadow: 0 0 12px currentColor; }
      100% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }
    
    .reward-stars {
      color: #ffd700;
      font-weight: bold;
      text-shadow: 0 0 8px #ffd700;
    }

    /* ====== å·²æ“æœ‰æ¨™è¨˜ ====== */
    .owned-stamp {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.7), rgba(162, 89, 255, 0.7));
      color: #fff;
      padding: 3px 7px;
      font-size: 0.75rem;
      border-radius: 6px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 10;
      backdrop-filter: blur(2px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .avatar-head {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center 40%; /* æˆ– center 35%/45% è¦–è‡‰éƒ¨ä½ç½®å¾®èª¿ */
      border-radius: 50%;
      display: block;
      transition: transform 0.3s;
    }

    /* ====== æ–°å¡ç‰‡é«˜äº®å‹•ç•« ====== */
    @keyframes newCardHighlight {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 16px #00ffff55, 0 0 32px #a259ff33;
      }
      50% { 
        transform: scale(1.1);
        box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc, 0 0 20px #ffd700;
      }
    }

    /* ====== ç¨€æœ‰åº¦åœ–æ¨™æ¨£å¼ ====== */
    .rarity-icon {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      font-size: 1.1rem;
      z-index: 15;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.8);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    .rarity-icon.common {
      background: linear-gradient(135deg, #00ffff, #00cccc);
      color: #000;
      box-shadow: 0 0 8px #00ffff, 0 0 16px #00ffff88;
    }
    
    .rarity-icon.rare {
      background: linear-gradient(135deg, #a259ff, #8a2be2);
      color: #fff;
      box-shadow: 0 0 8px #a259ff, 0 0 16px #a259ff88;
    }
    
    .rarity-icon.epic {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #000;
      box-shadow: 0 0 8px #ffd700, 0 0 16px #ffd70088;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“ å¡ç‰‡æ”¶è—</h1>
    <div class="header-actions">
      <span id="totalStarsCount" class="stars-display">â­ 0</span>
      <button class="btn" onclick="location.href='index.html'">ğŸ  é¦–é </button>
    </div>
  </header>

  <!-- æ–°å¢ï¼šåŠŸèƒ½é¸å–®å€åŸŸ -->
  <div id="featureMenu" style="
    background: rgba(10, 20, 40, 0.8);
    border: 2px solid #00ffff;
    border-radius: 12px;
    padding: 16px;
    margin: 10px auto;
    max-width: 900px;
    text-align: center;
    box-sizing: border-box;
  ">
    <h3 style="color: #00ffff; margin: 0 0 16px 0;">ğŸš€ å¿«é€ŸåŠŸèƒ½</h3>
    <div style="
      display: flex; 
      gap: 16px; 
      justify-content: center; 
      flex-wrap: wrap; 
      align-items: center;
      min-height: 44px;
    ">
      <button class="btn" onclick="location.href='gacha.html'">ğŸ´ æŠ½å¡</button>
    </div>
  </div>

  <!-- æœå°‹ã€ç¨€æœ‰åº¦ã€é¡åˆ¥ -->
  <div id="controls">
    <input type="text" id="searchInput" placeholder="æœå°‹å–®å­—æˆ–ä¸­æ–‡" oninput="renderCards()">
    <select id="rarityFilter" onchange="renderCards()">
      <option value="all">å…¨éƒ¨ç¨€æœ‰åº¦</option>
      <option value="æ™®é€š">æ™®é€š</option>
      <option value="ç¨€æœ‰">ç¨€æœ‰</option>
      <option value="è¶…ç¨€æœ‰">è¶…ç¨€æœ‰</option>
    </select>
    <select id="categoryFilter" onchange="renderCards()">
      <option value="all">å…¨éƒ¨é¡åˆ¥</option>
      <!-- JS æœƒå‹•æ…‹æŠŠ cards.js çš„ category å¡«é€²å» -->
    </select>
    <div class="tab-container">
      <button class="tab-btn active" data-filter="all">å…¨éƒ¨å¡ç‰‡</button>
      <button class="tab-btn" data-filter="owned">ğŸ“¦ æˆ‘çš„æ”¶è—</button>
    </div>
  </div>

  <div id="progress">å·²è§£é–ï¼š0 / 0</div>
  
  <!-- æ–°å¢ï¼šç¢ç‰‡ç³»çµ±èªªæ˜ -->
  <div id="shardInfo" style="
    background: rgba(10, 20, 40, 0.8);
    border: 2px solid #00ffff;
    border-radius: 12px;
    padding: 16px;
    margin: 10px auto;
    max-width: 900px;
    color: #fff;
    text-align: center;
    font-size: 0.9rem;
    line-height: 1.5;
  ">
    <h3 style="color: #00ffff; margin: 0 0 12px 0;">ğŸ’ ç¢ç‰‡ç³»çµ±</h3>
    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <span style="color: #ffd700;">æ™®é€šå¡ï¼š1ç‰‡</span>
      <span style="color: #a259ff;">ç¨€æœ‰å¡ï¼š3ç‰‡</span>
      <span style="color: #ff6b6b;">è¶…ç¨€æœ‰å¡ï¼š5ç‰‡</span>
    </div>
  </div>
  
  <div id="cardGrid"></div>

  <div id="overlay"></div>
  <div id="modal">
    <div class="card">
      <div class="close-btn" onclick="closeModal()">âœ•</div>
      <img id="modalImg" src="" alt="å¡ç‰‡åœ–ç‰‡">
      <div class="stars" id="modalStars">â˜…â˜…â˜…</div>
      <div class="label" id="modalLabel">
        <div class="chinese-text">å¡ç‰‡åç¨±</div>
        <div class="english-text">Card Name</div>
      </div>
      <div class="category-tag" id="modalCategory">é¡åˆ¥ï¼šç¯„ä¾‹</div>
      <div class="shard-count" id="modalShards">3/3</div>
    </div>
    <!-- åˆªé™¤å¡ç‰‡æ•ˆæœç›¸é—œå…ƒç´  -->
    <div class="modal-actions">
      <button class="sound-btn-modal" id="modalSoundBtn">ğŸ”Š æ’­æ”¾</button>
      <div id="disenchant-container" class="disenchant-container" style="display: none;">
        <div class="quantity-selector">
          <button id="quantity-minus" class="quantity-btn">-</button>
          <input type="number" id="disenchant-quantity" value="1" min="1" readonly>
          <button id="quantity-plus" class="quantity-btn">+</button>
        </div>
        <button class="disenchant-btn-modal" id="modalDisenchantBtn">â™»ï¸ åˆ†è§£</button>
      </div>
    </div>
    <audio id="modalAudio" src=""></audio>
  </div>

  <!-- å…ˆè¼‰å…¥ cards.jsï¼ˆå¿…é ˆæ”¾åœ¨é é¢ç›¸åŒè³‡æ–™å¤¾ï¼Œæˆ–è‡ªè¡Œä¿®æ”¹è·¯å¾‘ï¼‰ -->
  <script src="js/sound.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/starRewardSystem.js"></script>
  <script src="js/cardUtils.js"></script> <!-- å¼•å…¥å…±äº«çš„å¡ç‰Œå·¥å…·å‡½å¼ -->
  <!-- <script src="js/cards.js"></script> æš«æ™‚ç¦ç”¨ï¼Œæœ‰èªæ³•éŒ¯èª¤ -->
  <script src="cards.js"></script> <!-- è¼‰å…¥ä¸»å¡ç‰‡è³‡æ–™ï¼ŒåŒ…å«å½±ç‰‡å±¬æ€§ -->
  <script src="js/achievementSystem.js"></script>
  <script>
    // -------- 0. å¾ cards.js å–å¾— allCards è³‡æ–™ --------
    console.log('æ­£åœ¨è¼‰å…¥ allCards...');
    console.log('window.allCards:', window.allCards);
    
    // ç­‰å¾… cards.js å®Œå…¨è¼‰å…¥
    function waitForAllCards() {
      if (window.allCards && window.allCards.length > 0) {
        console.log('allCards è¼‰å…¥æˆåŠŸï¼Œé•·åº¦:', window.allCards.length);
        initializePage();
      } else {
        console.log('ç­‰å¾… allCards è¼‰å…¥...');
        setTimeout(waitForAllCards, 100);
      }
    }
    
    // -------- 1. å¾ localStorage æ‹¿ ownedCardsã€shards --------
    let ownedCards = LinkageSystem.cards.getOwnedCards();
    let shards = LinkageSystem.cards.getShards();
    let recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
    
    // é–‹å§‹ç­‰å¾… allCards è¼‰å…¥
    waitForAllCards();

    // -------- 2. æ ¹æ“šç¨€æœ‰åº¦å›å‚³æ‰€éœ€ç¢ç‰‡ï¼šæ™®é€š 1 / ç¨€æœ‰ 3 / è¶…ç¨€æœ‰ 5 --------
    
    // æ–°å¢ï¼šæ ¹æ“šç¨€æœ‰åº¦å›å‚³æ‰€éœ€ç¢ç‰‡æ•¸é‡
    function getRequiredShards(rarity) {
      switch(rarity) {
        case 'æ™®é€š': return 1;
        case 'ç¨€æœ‰': return 3;
        case 'è¶…ç¨€æœ‰': return 5;
        default: return 1;
      }
    }

    // -------- 3. åˆå§‹åŒ–ã€Œé¡åˆ¥é¸å–®ã€ --------
    function initCategoryOptions() {
      const categorySet = new Set();
      window.allCards.forEach(card => {
        if (card.category) categorySet.add(card.category);
      });
      const categoryFilter = document.getElementById("categoryFilter");
      // æ¸…æ‰é™¤äº†ã€Œå…¨éƒ¨ã€ä»¥å¤–çš„é¸é …
      Array.from(categoryFilter.querySelectorAll("option")).forEach(opt => {
        if (opt.value !== "all") opt.remove();
      });
      Array.from(categorySet).sort().forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categoryFilter.appendChild(option);
      });
    }

    // -------- 4. æ¸²æŸ“å¡ç‰‡å€‰åº«(æœå°‹+ç¯©é¸+è§£é–ç‹€æ…‹) --------
    function renderCards() {
      // é‡æ–°æ‹¿ localStorageï¼Œç¢ºä¿èˆ‡æŠ½å¡é åŒæ­¥
      ownedCards = LinkageSystem.cards.getOwnedCards();
      shards = LinkageSystem.cards.getShards();
      recentlyObtainedCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');

      const search = document.getElementById("searchInput").value.trim().toLowerCase();
      const filterRarity = document.getElementById("rarityFilter").value;
      const filterCategory = document.getElementById("categoryFilter").value;
      const ownedFilter = document.querySelector('.tab-btn.active').dataset.filter;
      const showOwnedOnly = (ownedFilter === 'owned');
      const grid = document.getElementById("cardGrid");
      grid.innerHTML = "";

      // å„ªåŒ–å¾Œçš„æ’åºé‚è¼¯
      const sortedCards = [...window.allCards].sort((a, b) => {
        const aIsUnlocked = LinkageSystem.cards.isCardOwned(a.word);
        const bIsUnlocked = LinkageSystem.cards.isCardOwned(b.word);
        const aShards = LinkageSystem.cards.getShardCount(a.word);
        const bShards = LinkageSystem.cards.getShardCount(b.word);
        
        const aIsDisenchantable = aIsUnlocked && aShards > 0;
        const bIsDisenchantable = bIsUnlocked && bShards > 0;

        // 1. "å¯åˆ†è§£" çš„å¡ç‰‡æœ€å„ªå…ˆ
        if (aIsDisenchantable !== bIsDisenchantable) {
          return aIsDisenchantable ? -1 : 1;
        }

        // 2. ç¢ç‰‡æ•¸é‡ç”±å¤šåˆ°å°‘æ’åº
        if (aShards !== bShards) {
          return bShards - aShards;
        }

        // 3. å·²è§£é–çš„å¡ç‰‡å„ªå…ˆ
        if (aIsUnlocked !== bIsUnlocked) {
          return aIsUnlocked ? -1 : 1;
        }

        // 4. ç¨€æœ‰åº¦é«˜çš„å„ªå…ˆ
        const rarityOrder = { 'è¶…ç¨€æœ‰': 3, 'ç¨€æœ‰': 2, 'æ™®é€š': 1 };
        const aRarity = rarityOrder[a.rarity] || 0;
        const bRarity = rarityOrder[b.rarity] || 0;
        if (aRarity !== bRarity) {
          return bRarity - aRarity;
        }
        
        // 5. æœ€å¾Œä¾ç…§ ID æ’åº
        return (a.id || 0) - (b.id || 0);
      });

      let unlockedCount = 0;
      sortedCards.forEach(card => {
        // æœå°‹å–®å­—æˆ–ä¸­æ–‡
        const combinedText = (card.word + card.zh).toLowerCase();
        const matchSearch = combinedText.includes(search);
        // ç¯©ç¨€æœ‰åº¦
        const matchRarity = (filterRarity === 'all' || card.rarity === filterRarity);
        // ç¯©é¡åˆ¥
        const matchCategory = (filterCategory === 'all' || card.category === filterCategory);

        const required = getRequiredShards(card.rarity);
        const haveShards = LinkageSystem.cards.getShardCount(card.word);
        const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);
        const isNewCardFlag = recentlyObtainedCards.includes(card.word);

        let shardDisplayHtml = '';
        if (isUnlocked) {
          shardDisplayHtml = `<div class="shard-count shard-unlocked">âœ”</div>`;
        } else {
          shardDisplayHtml = `<div class="shard-count">${haveShards}/${required}</div>`;
        }

        // ç¯©é¸å·²æœ‰å¡ç‰‡ (æ­¤åŠŸèƒ½å·²ç§»é™¤ï¼Œæ”¹ç‚ºæ¨™è¨˜)
        const matchOwned = !showOwnedOnly || isUnlocked;

        if (!(matchSearch && matchRarity && matchCategory && matchOwned)) return;

        // CSS class
        const rarityClass = card.rarity === 'æ™®é€š' ? 'common'
                             : card.rarity === 'ç¨€æœ‰' ? 'rare' : 'epic';

        const div = document.createElement("div");
        div.className = `card ${rarityClass}${isUnlocked ? ' unlocked' : ' locked'}`;
        div.setAttribute('data-word', card.word); // æ·»åŠ data-wordå±¬æ€§ç”¨æ–¼å®šä½
        
        // å¦‚æœæ˜¯æ–°å¡ç‰‡ï¼Œæ·»åŠ ç™¼å…‰æ•ˆæœ
        if (recentlyObtainedCards.includes(card.word) && isUnlocked) {
          div.classList.add('new-card-glow');
        }

        // æ ¹æ“šç¨€æœ‰åº¦æ±ºå®šé‚Šæ¡†åº•åœ–
        if (card.rarity === 'æ™®é€š') {
          div.style.backgroundImage = "url('img/border/common.jpg')";
        } else if (card.rarity === 'ç¨€æœ‰') {
          div.style.backgroundImage = "url('img/border/rare.png')";
        } else if (card.rarity === 'è¶…ç¨€æœ‰') {
          div.style.backgroundImage = "url('img/border/epic.png')";
        }

        // æ˜Ÿæ˜Ÿåœ–ç¤º
        let starIcons = '';
        if (card.rarity === 'æ™®é€š') starIcons = 'â˜…';
        else if (card.rarity === 'ç¨€æœ‰') starIcons = 'â˜…â˜…';
        else if (card.rarity === 'è¶…ç¨€æœ‰') starIcons = 'â˜…â˜…â˜…';

        // æº–å‚™å¡ç‰‡å…§å®¹
        let mediaContent = '';
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å½±ç‰‡ï¼ˆåŒ…æ‹¬ video å’Œ video_url å±¬æ€§ï¼‰
        const hasVideo = card.video || card.video_url;
        
        if (hasVideo) {
          // æœ‰å½±ç‰‡çš„å¡ç‰‡ï¼šåªæœ‰å·²è§£é–çš„å¡ç‰‡æ‰é¡¯ç¤ºå½±ç‰‡æŒ‰éˆ•
          const videoUrl = card.video || card.video_url;
          if (isUnlocked) {
            // å·²è§£é–ï¼šé¡¯ç¤ºåœ–ç‰‡ + å½±ç‰‡æŒ‰éˆ•
            mediaContent = `
              <div class="media-container" style="position: relative; width: 100%; height: 50%;">
                <img class="card-media" src="${card.image}" alt="${card.word}">
                <div class="video-button" onclick="event.stopPropagation(); playVideo('${videoUrl.replace(/'/g, "\\'")}', '${card.word}')">
                  <div class="video-icon">â–¶</div>
                </div>
              </div>
            `;
          } else {
            // æœªè§£é–ï¼šåªé¡¯ç¤ºåœ–ç‰‡ï¼Œä¸é¡¯ç¤ºå½±ç‰‡æŒ‰éˆ•
            mediaContent = `<img class="card-media" src="${card.image}" alt="${card.word}">`;
          }
        } else {
          // æ²’æœ‰å½±ç‰‡çš„å¡ç‰‡ï¼šåªé¡¯ç¤ºåœ–ç‰‡
          mediaContent = `<img class="card-media" src="${card.image}" alt="${card.word}">`;
        }

        let ownedStampHtml = '';
        if (isUnlocked) {
          ownedStampHtml = '<div class="owned-stamp">âœ” å·²æ“æœ‰</div>';
        }

        // æº–å‚™ç¨€æœ‰åº¦åœ–æ¨™
        let rarityIconHtml = '';
        let rarityText = '';
        if (card.rarity === 'æ™®é€š') {
          rarityText = 'A';
        } else if (card.rarity === 'ç¨€æœ‰') {
          rarityText = 'R';
        } else if (card.rarity === 'è¶…ç¨€æœ‰') {
          rarityText = 'SSR';
        }
        rarityIconHtml = `<div class="rarity-icon ${rarityClass}">${rarityText}</div>`;

        let cardContent = `
          ${rarityIconHtml}
          ${mediaContent}
          <div class="stars">${starIcons}</div>
          <div class="label">
            <div class="chinese-text">${card.zh}</div>
            <div class="english-text">${card.word}</div>
          </div>
          <div class="category-tag">é¡åˆ¥ï¼š${card.category}</div>
          <div class="description-tag">${card.description}</div>
          ${shardDisplayHtml}
        `;
        
        // å¦‚æœæ˜¯æ–°å¡ç‰‡ä¸”å·²è§£é–ï¼Œæ·»åŠ NEWæ¨™ç±¤
        if (recentlyObtainedCards.includes(card.word) && isUnlocked) {
          cardContent = `
            <div class="new-card-badge">NEW!</div>
            ${cardContent}
          `;
        }

        div.innerHTML = cardContent;

        // è‹¥å·²è§£é–ï¼Œæ‰ç¶é»æ“Šäº‹ä»¶é–‹ Modal
        if (isUnlocked) {
          div.onclick = (event) => {
            // æª¢æŸ¥æ˜¯å¦é»æ“Šçš„æ˜¯å½±ç‰‡æŒ‰éˆ•ï¼Œå¦‚æœæ˜¯å‰‡ä¸è™•ç†ï¼ˆè®“å½±ç‰‡æŒ‰éˆ•è‡ªå·±è™•ç†ï¼‰
            if (event.target.closest('.video-button')) {
              return;
            }
            
            // æ‰€æœ‰å¡ç‰‡éƒ½æ‰“é–‹ Modal
            openModal(card);
          };
          unlockedCount++;
        }
        
        // ç‚ºå½±ç‰‡æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆé˜»æ­¢å†’æ³¡åˆ°å¡ç‰‡é»æ“Šäº‹ä»¶ï¼‰
        const videoElement = div.querySelector('video');
        if (videoElement) {
          videoElement.addEventListener('click', (e) => {
            e.stopPropagation();
            if (videoElement.paused) {
              videoElement.play();
            } else {
              videoElement.pause();
            }
          });
        }

        grid.appendChild(div);
      });

      document.getElementById("progress").textContent = `å·²è§£é–ï¼š${unlockedCount} / ${window.allCards.length}`;
      
      // æ›´æ–°ç¢ç‰‡çµ±è¨ˆ
      updateShardStats();

      // ç‚ºæ¯å¼µå¡ç‰‡æ·»åŠ å³éµé¸å–®
      document.querySelectorAll('.card').forEach(cardElement => {
        cardElement.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          
          const cardWord = this.getAttribute('data-word');
          const card = window.allCards.find(c => c.word === cardWord);
          
          if (!card) return;
          
          // å¦‚æœæ˜¯ç”Ÿæ—¥è›‹ç³•å¡ç‰‡ä¸”æœªè¨­å®šç”Ÿæ—¥ï¼Œé¡¯ç¤ºç”Ÿæ—¥è¨­å®šé¸é …
          if (card.word === 'Birthday Cake' && !BirthdaySystem.hasBirthdaySet()) {
            showBirthdayContextMenu(e, card);
          }
        });
      });
    }

    // -------- 4.5. åˆ‡æ›å·²æœ‰å¡ç‰‡ç¯©é¸ --------
    function toggleOwnedFilter() {
      const button = document.getElementById("ownedFilter");
      button.classList.toggle("active");
      renderCards();
    }

    // -------- 5. Modal çš„é–‹å•Ÿ/é—œé–‰ é‚è¼¯ --------
    function openModal(card) {
      // ç§»é™¤è©²å¡ç‰‡çš„ NEW æ¨™è¨˜
      removeNewCardMarker(card.word);
      
      const required = getRequiredShards(card.rarity);
      const haveShards = LinkageSystem.cards.getShardCount(card.word);
      const isUnlocked = LinkageSystem.cards.isCardOwned(card.word);

      // æ›´æ–° Modal å…§å®¹
      const modalImg = document.getElementById("modalImg");
      // åªé¡¯ç¤ºåœ–ç‰‡ï¼Œä¸é¡¯ç¤ºå½±ç‰‡
      modalImg.outerHTML = `<img id="modalImg" class="card-media" src="${card.image}" alt="${card.word}">`;

      let starIcons = '';
      if (card.rarity === 'æ™®é€š') starIcons = 'â˜…';
      else if (card.rarity === 'ç¨€æœ‰') starIcons = 'â˜…â˜…';
      else if (card.rarity === 'è¶…ç¨€æœ‰') starIcons = 'â˜…â˜…â˜…';
      document.getElementById("modalStars").textContent = starIcons;

      // æ›´æ–°Modalä¸­çš„ä¸­æ–‡å’Œè‹±æ–‡æ–‡æœ¬
      const modalLabel = document.getElementById("modalLabel");
      modalLabel.innerHTML = `
        <div class="chinese-text">${card.zh}</div>
        <div class="english-text">${card.word}</div>
      `;
      
      document.getElementById("modalCategory").textContent = `é¡åˆ¥ï¼š${card.category}`;
      
      // ä¿®å¾©Modalä¸­çš„ç¢ç‰‡é¡¯ç¤º
      let modalShardText = '';
      if (isUnlocked) {
        modalShardText = 'å·²è§£é–';
      } else {
        modalShardText = `${haveShards}/${required}`;
      }
      document.getElementById("modalShards").textContent = modalShardText;
      
      // æ·»åŠ Modalä¸­çš„ç¨€æœ‰åº¦åœ–æ¨™
      const modalCard = document.querySelector('#modal .card');
      if (modalCard) {
        // ç§»é™¤ç¾æœ‰çš„ç¨€æœ‰åº¦åœ–æ¨™
        const existingIcon = modalCard.querySelector('.rarity-icon');
        if (existingIcon) {
          existingIcon.remove();
        }
        
        // æ·»åŠ æ–°çš„ç¨€æœ‰åº¦åœ–æ¨™
        let rarityText = '';
        if (card.rarity === 'æ™®é€š') {
          rarityText = 'A';
        } else if (card.rarity === 'ç¨€æœ‰') {
          rarityText = 'R';
        } else if (card.rarity === 'è¶…ç¨€æœ‰') {
          rarityText = 'SSR';
        }
        
        const rarityIcon = document.createElement('div');
        rarityIcon.className = `rarity-icon ${rarityClass}`;
        rarityIcon.textContent = rarityText;
        modalCard.appendChild(rarityIcon);
      }

      // å¦‚æœ card è£¡é¢æœ‰ audio å±¬æ€§ï¼Œå°±æ’­æ”¾éŸ³æª”ï¼›å¦å‰‡ç”¨èªéŸ³æœ—è®€
      const modalAudio = document.getElementById("modalAudio");
      const soundBtn = document.getElementById("modalSoundBtn");
      if (card.audio) {
        modalAudio.src = card.audio;
        soundBtn.onclick = playModalAudio;
      } else {
        modalAudio.src = "";
        soundBtn.onclick = () => {
          // ä½¿ç”¨æ–°çš„ç™¼éŸ³ç³»çµ±
          SoundSystem.speech.speakWord(card.word);
          setTimeout(() => {
            SoundSystem.speech.speak(card.zh, { lang: 'zh-TW' });
          }, 500);
        };
      }
      soundBtn.style.display = 'inline-flex';

      // è™•ç†åˆ†è§£æŒ‰éˆ•å’Œæ•¸é‡é¸æ“‡å™¨
      const disenchantContainer = document.getElementById("disenchant-container");
      const excessShards = haveShards - required;
      if (isUnlocked && excessShards > 0) {
        disenchantContainer.style.display = 'flex';
        
        const disenchantBtn = document.getElementById("modalDisenchantBtn");
        const quantityInput = document.getElementById("disenchant-quantity");
        const plusBtn = document.getElementById("quantity-plus");
        const minusBtn = document.getElementById("quantity-minus");

        const getStarsPerShard = (rarity) => {
          switch (rarity) {
            case 'è¶…ç¨€æœ‰': return 5;
            case 'ç¨€æœ‰': return 2;
            default: return 1;
          }
        };

        const updateDisenchantButton = () => {
          const quantity = parseInt(quantityInput.value);
          const starsGained = quantity * getStarsPerShard(card.rarity);
          disenchantBtn.innerHTML = `â™»ï¸ åˆ†è§£ ${quantity} å€‹ (â­${starsGained})`;
        };

        quantityInput.max = excessShards;
        quantityInput.value = 1;
        updateDisenchantButton();

        plusBtn.onclick = () => {
          if (parseInt(quantityInput.value) < excessShards) {
            quantityInput.value = parseInt(quantityInput.value) + 1;
            updateDisenchantButton();
          }
        };
        minusBtn.onclick = () => {
          if (parseInt(quantityInput.value) > 1) {
            quantityInput.value = parseInt(quantityInput.value) - 1;
            updateDisenchantButton();
          }
        };

        disenchantBtn.onclick = () => disenchantCard(card, parseInt(quantityInput.value));
      } else {
        disenchantContainer.style.display = 'none';
      }

      document.getElementById("overlay").style.display = "block";
      document.getElementById("modal").classList.add("show");
    }

    function disenchantCard(card, quantity) {
      const haveShards = LinkageSystem.cards.getShardCount(card.word);
      if (!LinkageSystem.cards.isCardOwned(card.word) || haveShards < quantity) {
        alert("æ¢ä»¶ä¸ç¬¦ï¼Œç„¡æ³•åˆ†è§£ï¼");
        return;
      }

      const getStarsPerShard = (rarity) => {
        switch (rarity) {
          case 'è¶…ç¨€æœ‰': return 5;
          case 'ç¨€æœ‰': return 2;
          default: return 1;
        }
      };
      const starsGained = quantity * getStarsPerShard(card.rarity);

      const confirmed = confirm(
        `æ‚¨ç¢ºå®šè¦å°‡ ${quantity} å€‹ã€Œ${card.zh}ã€ç¢ç‰‡åˆ†è§£æˆ ${starsGained} é¡†æ˜Ÿæ˜Ÿå—ï¼Ÿ`
      );

      if (confirmed) {
        let totalStars = parseInt(localStorage.getItem("totalStars") || "0");
        totalStars += starsGained;
        localStorage.setItem("totalStars", totalStars);
        
        // ä½¿ç”¨ LinkageSystem ä¾†æ¸›å°‘ç¢ç‰‡
        const currentShards = LinkageSystem.cards.getShards();
        currentShards[card.word] -= quantity;
        if (currentShards[card.word] <= 0) {
          delete currentShards[card.word];
        }
        LinkageSystem.cards.setShards(currentShards);
        
        // æ›´æ–°åˆ†è§£è¨ˆæ•¸å™¨ï¼ˆç”¨æ–¼æˆå°±ç³»çµ±ï¼‰
        const disenchantCount = parseInt(localStorage.getItem('disenchantCount') || '0') + quantity;
        localStorage.setItem('disenchantCount', disenchantCount.toString());
        
        alert(`æˆåŠŸåˆ†è§£ï¼\nç²å¾— ${starsGained} é¡†æ˜Ÿæ˜Ÿ âœ¨`);
        
        closeModal();
        renderCards();
        updateShardStats();
        
        if (typeof updateStars === 'function') {
            updateStars();
        }
      }
    }

    function closeModal() {
      // åœæ­¢Modalä¸­çš„å½±ç‰‡æ’­æ”¾
      const modalVideo = document.querySelector('#modal video');
      if (modalVideo) {
        modalVideo.pause();
        modalVideo.currentTime = 0;
      }
      
      document.getElementById("modal").classList.remove("show");
      document.getElementById("overlay").style.display = "none";
      // ä½¿ç”¨æ–°çš„ç™¼éŸ³ç³»çµ±åœæ­¢ç™¼éŸ³
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    }

    function playModalAudio() {
      const audioElem = document.getElementById("modalAudio");
      if (audioElem && audioElem.src) {
        audioElem.play();
      }
    }

    // -------- 6. é é¢è¼‰å…¥æ™‚å…ˆåˆå§‹åŒ– ã€Œé¡åˆ¥é¸å–®ã€ ä¸¦ renderCards() --------
    // ç§»é™¤é‡è¤‡çš„ window.addEventListener("load")ï¼Œçµ±ä¸€åœ¨ä¸‹æ–¹è™•ç†

    // è¨­ç½® Modal äº‹ä»¶
    function setupModalEvents() {
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById('modal');
      
      if (overlay) {
        // é»æ“ŠèƒŒæ™¯é®ç½©é—œé–‰ Modal
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closeModal();
          }
        });
      }
      
      if (modal) {
        // é»æ“Š Modal å…§å®¹å€åŸŸä¸é—œé–‰
        modal.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      }
      
      // ESC éµé—œé–‰ Modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    }

    // -------- 7. ç¢ç‰‡ç³»çµ±ç›¸é—œå‡½æ•¸ --------
    // å·²åˆªé™¤ toggleShardInfo å‡½æ•¸ï¼Œå› ç‚ºä¸å†éœ€è¦åˆ‡æ›èªªæ˜é¡¯ç¤º

    // -------- 8. æ–°å¡ç‰‡ç³»çµ±ç›¸é—œå‡½æ•¸ --------
    function clearNewCardMarkers() {
      // æ¸…é™¤æœ€è¿‘ç²å¾—çš„å¡ç‰‡æ¨™è¨˜
      localStorage.removeItem('recentlyObtainedCards');
      localStorage.removeItem('newCardTimestamps');
      recentlyObtainedCards = [];
      renderCards();
    }

    function addNewCard(cardWord) {
      // æ·»åŠ æ–°å¡ç‰‡åˆ°æœ€è¿‘ç²å¾—åˆ—è¡¨
      let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      let cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      
      if (!recentCards.includes(cardWord)) {
        recentCards.push(cardWord);
        // è¨˜éŒ„ç²å¾—æ™‚é–“æˆ³
        cardTimestamps[cardWord] = Date.now();
        
        // åªä¿ç•™æœ€è¿‘20å¼µæ–°å¡ç‰‡
        if (recentCards.length > 20) {
          const oldestCard = recentCards.shift();
          delete cardTimestamps[oldestCard];
        }
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
      }
    }

    // ç§»é™¤å–®å¼µå¡ç‰‡çš„ NEW æ¨™è¨˜
    function removeNewCardMarker(cardWord) {
      let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      let cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      
      // å¦‚æœå¡ç‰‡åœ¨æ–°å¡ç‰‡åˆ—è¡¨ä¸­ï¼Œå‰‡ç§»é™¤å®ƒ
      if (recentCards.includes(cardWord)) {
        recentCards = recentCards.filter(card => card !== cardWord);
        delete cardTimestamps[cardWord];
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
        
        // æ›´æ–°é é¢è®Šæ•¸
        recentlyObtainedCards = recentCards;
        
        // é‡æ–°æ¸²æŸ“å¡ç‰‡ä»¥ç§»é™¤ NEW æ¨™è¨˜
        renderCards();
        
        console.log(`âœ… å·²ç§»é™¤ã€Œ${cardWord}ã€çš„ NEW æ¨™è¨˜`);
      }
    }

    // è‡ªå‹•æ¸…é™¤æ–°å¡ç‰‡æ¨™è¨˜ï¼ˆ10åˆ†é˜å¾Œï¼‰
    function autoClearNewCards() {
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      const now = Date.now();
      const tenMinutes = 10 * 60 * 1000; // 10åˆ†é˜
      
      let hasExpiredCards = false;
      const expiredCards = [];
      
      // æª¢æŸ¥æ˜¯å¦æœ‰éæœŸçš„å¡ç‰‡
      Object.keys(cardTimestamps).forEach(cardWord => {
        const timestamp = cardTimestamps[cardWord];
        if (now - timestamp > tenMinutes) {
          expiredCards.push(cardWord);
          delete cardTimestamps[cardWord];
          hasExpiredCards = true;
        }
      });
      
      // å¦‚æœæœ‰éæœŸå¡ç‰‡ï¼Œæ›´æ–° localStorage
      if (hasExpiredCards) {
        let recentCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
        recentCards = recentCards.filter(card => !expiredCards.includes(card));
        
        localStorage.setItem('recentlyObtainedCards', JSON.stringify(recentCards));
        localStorage.setItem('newCardTimestamps', JSON.stringify(cardTimestamps));
        
        // æ›´æ–°é é¢è®Šæ•¸
        recentlyObtainedCards = recentCards;
        
        // é‡æ–°æ¸²æŸ“å¡ç‰‡ä»¥ç§»é™¤éæœŸçš„ NEW æ¨™è¨˜
        renderCards();
        
        console.log(`â° å·²ç§»é™¤ ${expiredCards.length} å¼µéæœŸçš„æ–°å¡ç‰‡æ¨™è¨˜ï¼š`, expiredCards);
      }
    }

    // æª¢æŸ¥å¡ç‰‡æ˜¯å¦ç‚ºæ–°å¡ç‰‡ï¼ˆ10åˆ†é˜å…§ï¼‰
    function isNewCard(cardWord) {
      const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
      const timestamp = cardTimestamps[cardWord];
      
      if (!timestamp) return false;
      
      const now = Date.now();
      const tenMinutes = 10 * 60 * 1000; // 10åˆ†é˜
      
      return (now - timestamp) <= tenMinutes;
    }

    // ç²å–æ•ˆæœé¡å‹çš„ä¸­æ–‡åç¨±
    function getEffectTypeName(effectType) {
      const typeNames = {
        'time_extend': 'æ™‚é–“å»¶é•·',
        'time_freeze': 'æ™‚é–“æš«åœ',
        'hint': 'æç¤ºè¼”åŠ©',
        'shield': 'è­·ç›¾ä¿è­·',
        'energy_restore': 'èƒ½é‡æ¢å¾©',
        'combo_protect': 'é€£æ“Šä¿è­·',
        'score_multiply': 'åˆ†æ•¸åŠ å€',
        'skip_level': 'è·³éé—œå¡'
      };
      return typeNames[effectType] || 'æœªçŸ¥æ•ˆæœ';
    }

    // èª¿è©¦ä¿¡æ¯
    // function debugNewCardInfo() {
    //   console.log('ğŸ” èª¿è©¦ä¿¡æ¯ï¼š');
    //   console.log('recentlyObtainedCards:', recentlyObtainedCards);
    //   console.log('ownedCards keys:', Object.keys(ownedCards));
    //   console.log('localStorage recentlyObtainedCards:', localStorage.getItem('recentlyObtainedCards'));
    //   
    //   // é¡¯ç¤ºæ™‚é–“æˆ³ä¿¡æ¯
    //   const cardTimestamps = JSON.parse(localStorage.getItem('newCardTimestamps') || '{}');
    //   console.log('newCardTimestamps:', cardTimestamps);
    //   
    //   // é¡¯ç¤ºæ¯å¼µæ–°å¡ç‰‡çš„å‰©é¤˜æ™‚é–“
    //   const now = Date.now();
    //   const tenMinutes = 10 * 60 * 1000;
    //   Object.keys(cardTimestamps).forEach(cardWord => {
    //     const timestamp = cardTimestamps[cardWord];
    //     const elapsed = now - timestamp;
    //     const remaining = tenMinutes - elapsed;
    //     const remainingMinutes = Math.max(0, Math.floor(remaining / 60000));
    //     const remainingSeconds = Math.max(0, Math.floor((remaining % 60000) / 1000));
    //     console.log(`â° ${cardWord}: å‰©é¤˜ ${remainingMinutes}åˆ†${remainingSeconds}ç§’`);
    //   });
    // }

    // æ›´æ–°ç¢ç‰‡çµ±è¨ˆ
    function updateShardStats() {
      const totalCards = window.allCards.length;
      const ownedCards = LinkageSystem.cards.getOwnedCards();
      const shards = LinkageSystem.cards.getShards();
      const unlockedCards = Object.keys(ownedCards).length;
      const totalShards = Object.values(shards).reduce((sum, count) => sum + count, 0);
      
      // æ›´æ–°é é¢é ‚éƒ¨çš„æ˜Ÿæ˜Ÿé¡¯ç¤º
      const totalStars = parseInt(localStorage.getItem('totalStars') || '0');
      const starsDisplay = document.getElementById('totalStarsCount');
      if (starsDisplay) {
        starsDisplay.textContent = `â­ ${totalStars}`;
      }
      
      // è¨ˆç®—å„ç¨€æœ‰åº¦çš„çµ±è¨ˆ
      const rarityStats = {
        'æ™®é€š': { total: 0, unlocked: 0, shards: 0 },
        'ç¨€æœ‰': { total: 0, unlocked: 0, shards: 0 },
        'è¶…ç¨€æœ‰': { total: 0, unlocked: 0, shards: 0 }
      };
      
      window.allCards.forEach(card => {
        const rarity = card.rarity;
        rarityStats[rarity].total++;
        
        if (LinkageSystem.cards.isCardOwned(card.word)) {
          rarityStats[rarity].unlocked++;
        }
        
        const cardShards = LinkageSystem.cards.getShardCount(card.word);
        rarityStats[rarity].shards += cardShards;
      });
      
      // æ›´æ–°é€²åº¦é¡¯ç¤º
      const progressText = `å·²è§£é–ï¼š${unlockedCards} / ${totalCards} | ç¸½ç¢ç‰‡ï¼š${totalShards}`;
      document.getElementById("progress").textContent = progressText;
      
      // æ›´æ–°èªªæ˜ä¸­çš„çµ±è¨ˆ
      const statsDiv = document.createElement("div");
      statsDiv.innerHTML = `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #00ffff44;">
          <h4 style="color: #ffd700; margin: 0 0 8px 0; text-align: center;">ğŸ“Š æ”¶é›†é€²åº¦</h4>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
            <div>
              <div style="color: #00ffff; font-weight: bold;">æ™®é€š</div>
              <div style="font-size: 0.8rem;">${rarityStats['æ™®é€š'].unlocked}/${rarityStats['æ™®é€š'].total}</div>
              <div style="font-size: 0.7rem; color: #ccc;">ç¢ç‰‡: ${rarityStats['æ™®é€š'].shards}</div>
            </div>
            <div>
              <div style="color: #a259ff; font-weight: bold;">ç¨€æœ‰</div>
              <div style="font-size: 0.8rem;">${rarityStats['ç¨€æœ‰'].unlocked}/${rarityStats['ç¨€æœ‰'].total}</div>
              <div style="font-size: 0.7rem; color: #ccc;">ç¢ç‰‡: ${rarityStats['ç¨€æœ‰'].shards}</div>
            </div>
            <div>
              <div style="color: #ffd700; font-weight: bold;">è¶…ç¨€æœ‰</div>
              <div style="font-size: 0.8rem;">${rarityStats['è¶…ç¨€æœ‰'].unlocked}/${rarityStats['è¶…ç¨€æœ‰'].total}</div>
              <div style="font-size: 0.7rem; color: #ccc;">ç¢ç‰‡: ${rarityStats['è¶…ç¨€æœ‰'].shards}</div>
            </div>
          </div>
        </div>
      `;
      
      // ç§»é™¤èˆŠçš„çµ±è¨ˆï¼Œæ·»åŠ æ–°çš„
      const oldStats = document.querySelector("#shardInfo .stats-section");
      if (oldStats) oldStats.remove();
      
      statsDiv.classList.add("stats-section");
      document.getElementById("shardInfo").appendChild(statsDiv);
    }

    // -------- 9. YouTube å½±ç‰‡ç›¸é—œå‡½æ•¸ --------
    
    // æ’­æ”¾å½±ç‰‡å‡½æ•¸
    function playVideo(videoUrl, cardWord) {
      if (!videoUrl) {
        alert('æ²’æœ‰å½±ç‰‡é€£çµ');
        return;
      }
      
      // æª¢æŸ¥æ˜¯å¦ç‚º YouTube é€£çµ
      if (/youtu(be\.com|\.be)/.test(videoUrl)) {
        const youtubeId = extractYouTubeId(videoUrl);
        if (youtubeId) {
          // é–‹å•Ÿ YouTube å½±ç‰‡ Modal
          openVideoModal(youtubeId, cardWord, 'youtube');
        } else {
          alert('YouTube é€£çµæ ¼å¼éŒ¯èª¤');
        }
      } else {
        // æœ¬åœ° MP4 å½±ç‰‡
        openVideoModal(videoUrl, cardWord, 'mp4');
      }
    }
    
    // é–‹å•Ÿå½±ç‰‡ Modal
    function openVideoModal(videoSource, cardWord, type) {
      // å‰µå»ºå½±ç‰‡ Modal
      const modal = document.createElement('div');
      modal.className = 'video-modal';
      modal.innerHTML = `
        <div class="video-modal-content">
          <div class="video-modal-header">
            <h3>${cardWord}</h3>
            <button class="video-modal-close" onclick="closeVideoModal()">Ã—</button>
          </div>
          <div class="video-modal-body">
            ${type === 'youtube' 
              ? `<iframe src="https://www.youtube.com/embed/${videoSource}?controls=1&showinfo=1&rel=0&modestbranding=1" 
                   frameborder="0" allow="encrypted-media" allowfullscreen></iframe>`
              : `<video controls>
                   <source src="${videoSource}" type="video/mp4">
                   æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾
                 </video>`
            }
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeVideoModal();
        }
      });
      
      // ESC éµé—œé–‰ Modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeVideoModal();
        }
      });
    }
    
    // é—œé–‰å½±ç‰‡ Modal
    function closeVideoModal() {
      const modal = document.querySelector('.video-modal');
      if (modal) {
        modal.remove();
      }
    }
    
    function extractYouTubeId(url) {
      const patterns = [
        /(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([\w-]{11})/,
        /youtube\.com\/embed\/([\w-]{11})/,
        /youtu\.be\/([\w-]{11})/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }

    function addShard(cardWord, amount, rarity) {
      if (LinkageSystem.cards.isCardOwned(cardWord)) {
        // å·²è§£é–ï¼Œç›´æ¥çµ¦æ˜Ÿæ˜Ÿ
        let starReward = 0;
        switch(rarity) {
          case 'è¶…ç¨€æœ‰': starReward = amount * 5; break;
          case 'ç¨€æœ‰': starReward = amount * 2; break;
          case 'æ™®é€š': starReward = amount * 1; break;
        }
        // ...åŠ æ˜Ÿæ˜Ÿ...
        return;
      }
      // æœªè§£é–æ‰åŠ ç¢ç‰‡
      LinkageSystem.cards.addShard(cardWord, amount);
    }

    // =================== æ¸¬è©¦è€…æ•´åˆç¨‹å¼ç¢¼ ===================
    // å¦‚æœè¦ç”¨æ¸¬è©¦è€…æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼šåŠ æ˜Ÿã€è§£é–æ‰€æœ‰ï¼‰ï¼Œå¯ä»¥åœ¨ localStorage è£¡æ”¾ testerInstructions
    // { "addStars": true, "unlockAllCards": true, "testerMode": true }
    let stars = parseInt(localStorage.getItem("totalStars") || "0");

    function updateStars() {
      // å¦‚æœæœ‰ #stars æˆ– #totalStarsCount å…ƒç´ ï¼Œå°±æ›´æ–°å®ƒ
      const el = document.getElementById("stars") || document.getElementById("totalStarsCount");
      if (el) el.textContent = stars;
      localStorage.setItem("totalStars", stars);
    }

    window.addEventListener("load", () => {
      updateStars();
      
      // æª¢æŸ¥ allCards æ˜¯å¦è¼‰å…¥æˆåŠŸ
      if (!window.allCards || window.allCards.length === 0) {
        console.error('è­¦å‘Šï¼šallCards ç‚ºç©ºé™£åˆ—ï¼Œå¯èƒ½æ˜¯ cards.js è¼‰å…¥å¤±æ•—');
        waitForAllCards();
      } else {
        initializePage();
      }
    });

    // âœ¨ æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰å¡ç‰‡ä½œå¼Šç¢¼ âœ¨
    // åœ¨é é¢ä¸­ç›´æ¥è¼¸å…¥ clean ç„¶å¾ŒæŒ‰ä¸‹ Enter å³å¯æ¸…é™¤æ‰€æœ‰å¡ç‰‡å’Œç¢ç‰‡
    let cleanCodeBuffer = '';
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (cleanCodeBuffer.toLowerCase() === 'clean') {
          if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡ç‰‡å’Œç¢ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
            // æ¸…é™¤æ‰€æœ‰å¡ç‰‡å’Œç¢ç‰‡
            LinkageSystem.cards.setOwnedCards({});
            LinkageSystem.cards.setShards({});
            localStorage.removeItem('recentlyObtainedCards');
            localStorage.removeItem('newCardTimestamps');
            
            // é‡æ–°è¼‰å…¥é é¢è®Šæ•¸
            ownedCards = {};
            shards = {};
            recentlyObtainedCards = [];
            
            // é‡æ–°æ¸²æŸ“å¡ç‰‡
            renderCards();
            
            // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
            alert('ğŸ§¹ æ‰€æœ‰å¡ç‰‡å’Œç¢ç‰‡å·²æ¸…é™¤ï¼');
            console.log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰å¡ç‰‡å’Œç¢ç‰‡');
          }
        }
        cleanCodeBuffer = ''; // æ¯æ¬¡æŒ‰ Enter éƒ½é‡ç½®
      } else if (e.key === 'Backspace') {
        // æ”¯æ´é€€æ ¼éµ
        cleanCodeBuffer = cleanCodeBuffer.slice(0, -1);
      } else if (e.key.length === 1) {
        // åªè¨˜éŒ„å–®ä¸€å­—ç¬¦çš„æŒ‰éµ
        cleanCodeBuffer += e.key;
      }
      
      // é¿å…å­—ä¸²ç„¡é™å¢é•·
      if (cleanCodeBuffer.length > 100) {
        cleanCodeBuffer = '';
      }
    });

    console.log('allCards é•·åº¦:', window.allCards.length);

    if (!window.allCards || window.allCards.length === 0) {
      console.error('è­¦å‘Šï¼šallCards ç‚ºç©ºé™£åˆ—ï¼Œå¯èƒ½æ˜¯ cards.js è¼‰å…¥å¤±æ•—');
      waitForAllCards();
    } else {
      initializePage();
    }

    function initializePage() {
      // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
      if (typeof SoundSystem !== 'undefined') {
        SoundSystem.speech.init();
      }
      
      // åˆå§‹åŒ–é ç±¤æŒ‰éˆ•
      document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const clickedButton = e.currentTarget;
          if (clickedButton.classList.contains('active')) {
            return; // å¦‚æœé»æ“Šçš„å·²ç¶“æ˜¯å•Ÿç”¨ç‹€æ…‹ï¼Œå‰‡ä¸é‡è¤‡åŸ·è¡Œ
          }
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          clickedButton.classList.add('active');
          renderCards();
        });
      });
      
      // åˆå§‹åŒ–æ–°å¡ç‰‡ç³»çµ±
      autoClearNewCards();
      
      // è¨­ç½®å®šæ™‚å™¨ï¼Œæ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡éæœŸçš„æ–°å¡ç‰‡æ¨™è¨˜
      setInterval(autoClearNewCards, 60 * 1000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
      
      // åˆå§‹åŒ–é é¢
      initCategoryOptions();
      renderCards();
      updateShardStats();
      
      // è¨­ç½® Modal äº‹ä»¶
      setupModalEvents();
      
      // æª¢æŸ¥ä¸¦çªå‡ºé¡¯ç¤ºæ–°è§£é–çš„å¡ç‰‡
      setTimeout(() => {
        highlightNewCards();
      }, 500); // å»¶é²500msç¢ºä¿å¡ç‰‡å·²æ¸²æŸ“å®Œæˆ
      
      // èª¿è©¦ä¿¡æ¯
      // debugNewCardInfo();
      
      // å¦‚æœæœ‰æ–°å¡ç‰‡ï¼Œé¡¯ç¤ºæç¤º
      if (recentlyObtainedCards.length > 0) {
        console.log(`ğŸ‰ ç™¼ç¾ ${recentlyObtainedCards.length} å¼µæ–°å¡ç‰‡ï¼`);
      } else {
        console.log('ğŸ“ ç›®å‰æ²’æœ‰æ–°å¡ç‰‡æ¨™è¨˜');
      }
    }

    // -------- 9. YouTube å½±ç‰‡ç›¸é—œå‡½æ•¸ --------
    
    // æ–°å¢ï¼šæª¢æŸ¥ä¸¦çªå‡ºé¡¯ç¤ºæ–°è§£é–çš„å¡ç‰‡
    function highlightNewCards() {
      const newCards = JSON.parse(localStorage.getItem('recentlyObtainedCards') || '[]');
      if (newCards.length === 0) return;
      
      // æ‰¾åˆ°æœ€æ–°è§£é–çš„å¡ç‰‡å…ƒç´ 
      const latestCard = newCards[newCards.length - 1];
      const cardElement = document.querySelector(`[data-word="${latestCard}"]`);
      
      if (cardElement) {
        // æ»¾å‹•åˆ°å¡ç‰‡ä½ç½®
        cardElement.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        // æ·»åŠ é–ƒçˆå‹•ç•«æ•ˆæœ
        cardElement.style.animation = 'newCardHighlight 2s ease-in-out infinite';
        
        // 2ç§’å¾Œç§»é™¤å‹•ç•«
        setTimeout(() => {
          cardElement.style.animation = '';
        }, 2000);
        
        console.log(`ğŸ¯ å·²æ»¾å‹•åˆ°æ–°è§£é–çš„å¡ç‰‡ï¼š${latestCard}`);
      }
    }
    
    // æ–°å¢ï¼šæ–°å¡ç‰‡é«˜äº®å‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
      @keyframes newCardHighlight {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 16px #00ffff55, 0 0 32px #a259ff33;
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 32px #00ffff, 0 0 48px #a259ffcc, 0 0 20px #ffd700;
        }
      }
    `;
    document.head.appendChild(style);

    // è¼”åŠ©å‡½æ•¸ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºSSR
    function isSSR(card) {
      return card.rarity === 'è¶…ç¨€æœ‰' || card.rarity === 'ç¯€æ—¥é™å®š';
    }

    // é¡¯ç¤ºç”Ÿæ—¥è¨­å®šå³éµé¸å–®
    function showBirthdayContextMenu(e, card) {
      // ç§»é™¤ç¾æœ‰çš„å³éµé¸å–®
      const existingMenu = document.querySelector('.context-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      const menu = document.createElement('div');
      menu.className = 'context-menu';
      menu.style.cssText = `
        position: fixed;
        top: ${e.clientY}px;
        left: ${e.clientX}px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        padding: 8px 0;
        min-width: 200px;
      `;
      
      menu.innerHTML = `
        <div style="padding: 8px 16px; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
          ğŸ‚ ç”Ÿæ—¥è›‹ç³•å¡ç‰‡
        </div>
        <div style="padding: 8px 16px; cursor: pointer; transition: background 0.2s;" 
             onmouseover="this.style.background='#f5f5f5'" 
             onmouseout="this.style.background='transparent'"
             onclick="BirthdaySystem.showBirthdaySetupDialog(); this.parentElement.remove();">
          ğŸ“… è¨­å®šç”Ÿæ—¥æ—¥æœŸ
        </div>
        <div style="padding: 8px 16px; color: #666; font-size: 12px;">
          è¨­å®šå¾Œåœ¨ç”Ÿæ—¥ç•¶å¤©æœƒè‡ªå‹•ç²å¾—æ­¤å¡ç‰‡
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
      setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        });
      }, 100);
    }

    // åœ¨é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ç”Ÿæ—¥ç³»çµ±
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥ä¸¦é¡¯ç¤ºç”Ÿæ—¥ç¥ç¦
      if (typeof BirthdaySystem !== 'undefined') {
        BirthdaySystem.checkAndGiveBirthdayCard();
      }
    });

    console.log('allCards é•·åº¦:', window.allCards.length);
  </script>
</body>
</html>
